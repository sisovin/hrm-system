<?php

namespace App\Filament\Pages;

use App\Jobs\GeneratePayrollJob;
use App\Models\Employee;
use App\Models\Payroll;
use Filament\Forms\Components\DatePicker;
use Filament\Forms\Components\Select;
use Filament\Forms\Concerns\InteractsWithForms;
use Filament\Forms\Contracts\HasForms;
use Filament\Forms\Form;
use Filament\Notifications\Notification;
use Filament\Pages\Page;
use Filament\Tables\Actions\Action;
use Filament\Tables\Columns\TextColumn;
use Filament\Tables\Concerns\InteractsWithTable;
use Filament\Tables\Contracts\HasTable;
use Filament\Tables\Filters\SelectFilter;
use Filament\Tables\Table;
use Illuminate\Support\Facades\Bus;

class PayrollGeneration extends Page implements HasForms, HasTable
{
    use InteractsWithForms;
    use InteractsWithTable;

    protected static string|\BackedEnum|null $navigationIcon = 'heroicon-o-currency-dollar';

    protected static string $view = 'filament.pages.payroll-generation';
    
    protected static string|\UnitEnum|null $navigationGroup = 'HR Management';
    
    protected static ?int $navigationSort = 6;
    
    protected static ?string $navigationLabel = 'Payroll Generation';

    public ?array $data = [];

    public function mount(): void
    {
        $this->form->fill([
            'pay_period_start' => now()->startOfMonth(),
            'pay_period_end' => now()->endOfMonth(),
        ]);
    }

    public function form(Form $form): Form
    {
        return $form
            ->schema([
                DatePicker::make('pay_period_start')
                    ->label('Pay Period Start')
                    ->required()
                    ->default(now()->startOfMonth()),
                DatePicker::make('pay_period_end')
                    ->label('Pay Period End')
                    ->required()
                    ->default(now()->endOfMonth())
                    ->after('pay_period_start'),
                Select::make('department')
                    ->label('Department (Optional)')
                    ->options([
                        'IT' => 'IT',
                        'HR' => 'Human Resources',
                        'Finance' => 'Finance',
                        'Sales' => 'Sales',
                        'Marketing' => 'Marketing',
                        'Operations' => 'Operations',
                        'Customer Service' => 'Customer Service',
                    ])
                    ->placeholder('All Departments')
                    ->searchable(),
            ])
            ->statePath('data')
            ->columns(3);
    }

    public function generatePayroll(): void
    {
        $data = $this->form->getState();
        
        $query = Employee::where('status', 'active');
        
        if (!empty($data['department'])) {
            $query->where('department', $data['department']);
        }
        
        $employees = $query->get();
        
        if ($employees->isEmpty()) {
            Notification::make()
                ->title('No Employees Found')
                ->body('No active employees match the criteria.')
                ->warning()
                ->send();
            return;
        }

        $jobs = [];
        foreach ($employees as $employee) {
            // Check if payroll already exists for this period
            $exists = Payroll::where('employee_id', $employee->id)
                ->whereBetween('pay_date', [$data['pay_period_start'], $data['pay_period_end']])
                ->exists();
                
            if (!$exists) {
                $jobs[] = new GeneratePayrollJob(
                    $employee->id,
                    $data['pay_period_start'],
                    $data['pay_period_end']
                );
            }
        }

        if (empty($jobs)) {
            Notification::make()
                ->title('Payroll Already Generated')
                ->body('Payroll already exists for this period.')
                ->warning()
                ->send();
            return;
        }

        Bus::batch($jobs)
            ->name('Payroll Generation - ' . now()->format('Y-m-d'))
            ->dispatch();

        Notification::make()
            ->title('Payroll Generation Started')
            ->body(count($jobs) . ' payroll records are being generated.')
            ->success()
            ->send();
    }

    public function table(Table $table): Table
    {
        return $table
            ->query(Payroll::query()->with('employee')->latest('pay_date'))
            ->columns([
                TextColumn::make('employee.first_name')
                    ->label('Employee')
                    ->formatStateUsing(fn ($record) => $record->employee->first_name . ' ' . $record->employee->last_name)
                    ->searchable(['first_name', 'last_name'])
                    ->sortable(),
                TextColumn::make('employee.department')
                    ->label('Department')
                    ->badge()
                    ->sortable(),
                TextColumn::make('pay_date')
                    ->label('Pay Date')
                    ->date()
                    ->sortable(),
                TextColumn::make('basic_salary')
                    ->money('USD')
                    ->sortable(),
                TextColumn::make('bonuses')
                    ->money('USD')
                    ->sortable(),
                TextColumn::make('deductions')
                    ->money('USD')
                    ->sortable(),
                TextColumn::make('net_salary')
                    ->money('USD')
                    ->sortable()
                    ->weight('bold')
                    ->color('success'),
                TextColumn::make('status')
                    ->badge()
                    ->color(fn (string $state): string => match ($state) {
                        'paid' => 'success',
                        'pending' => 'warning',
                        'cancelled' => 'danger',
                        default => 'gray',
                    }),
            ])
            ->filters([
                SelectFilter::make('department')
                    ->options([
                        'IT' => 'IT',
                        'HR' => 'Human Resources',
                        'Finance' => 'Finance',
                        'Sales' => 'Sales',
                        'Marketing' => 'Marketing',
                        'Operations' => 'Operations',
                    ])
                    ->query(function ($query, $data) {
                        if (!empty($data['value'])) {
                            $query->whereHas('employee', function ($q) use ($data) {
                                $q->where('department', $data['value']);
                            });
                        }
                    }),
                SelectFilter::make('status')
                    ->options([
                        'paid' => 'Paid',
                        'pending' => 'Pending',
                        'cancelled' => 'Cancelled',
                    ]),
            ])
            ->actions([
                Action::make('markAsPaid')
                    ->label('Mark as Paid')
                    ->icon('heroicon-o-check-circle')
                    ->color('success')
                    ->visible(fn ($record) => $record->status === 'pending')
                    ->requiresConfirmation()
                    ->action(function ($record) {
                        $record->update(['status' => 'paid']);
                        Notification::make()
                            ->title('Payroll Marked as Paid')
                            ->success()
                            ->send();
                    }),
            ])
            ->bulkActions([
                Action::make('markAllAsPaid')
                    ->label('Mark as Paid')
                    ->icon('heroicon-o-check-circle')
                    ->color('success')
                    ->requiresConfirmation()
                    ->action(function ($records) {
                        $records->each->update(['status' => 'paid']);
                        Notification::make()
                            ->title('Payrolls Marked as Paid')
                            ->body(count($records) . ' records updated.')
                            ->success()
                            ->send();
                    }),
            ])
            ->defaultSort('pay_date', 'desc');
    }
}
